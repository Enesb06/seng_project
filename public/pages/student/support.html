<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destek Merkezi</title>

    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="dashboard-container">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo"><a href="../../student.html">LearnEnglish</a></div>
        <nav>
            <ul>
                <li><a href="../../student.html">Ana Sayfa</a></li>
                <li><a href="reading.html">Okuma Materyalleri</a></li>
                <li><a href="favorites.html">â­ Favorilerim</a></li>
                <li><a href="wordlist.html">Kelime Listem</a></li>
                <li><a href="quiz.html">Quiz'lerim</a></li>
                <li class="active"><a href="support.html">ğŸ’¬ Destek</a></li>
                <li><a href="profile.html">Profilim & Ä°statistikler</a></li>
                <li><a href="../common/settings.html">âš™ï¸ Ayarlar</a></li>
            </ul>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main-content">
        <!-- ÃœST BAR (GÃœNCELLENDÄ°) -->
        <header class="dashboard-header">
            <h2>ğŸ’¬ Destek &amp; Geri Bildirim</h2>
            <div class="user-info" style="display: flex; align-items: center; gap: 15px;">
                <img id="header-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=base" style="width: 35px; height: 35px; border-radius: 50%; border: 2px solid #4CAF50; object-fit: cover;">
                <span id="welcome-message"></span>
                <button id="logout-button">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </header>

        <!-- ORTALANMIÅ Ä°Ã‡ERÄ°K -->
        <main class="content-area"
              style="display:flex; flex-direction:column; gap:20px; max-width:850px; margin:0 auto; width:100%;">

            <!-- YENÄ° KONU AÃ‡MA -->
            <div class="card" style="padding:20px;">
                <h3 style="margin-top:0; margin-bottom:12px;">Yeni Destek Talebi OluÅŸtur</h3>

                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div>
                        <label for="support-subject"
                               style="display:block;font-size:0.9rem;font-weight:600;margin-bottom:4px;">
                            Konu BaÅŸlÄ±ÄŸÄ±
                        </label>
                        <input id="support-subject"
                               type="text"
                               placeholder="Ã–rn: Quiz aÃ§Ä±lmÄ±yor, okuma metni gÃ¶rÃ¼nmÃ¼yor..."
                               style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;
                                      font-size:0.95rem;box-sizing:border-box;">
                    </div>

                    <div>
                        <label for="support-message"
                               style="display:block;font-size:0.9rem;font-weight:600;margin-bottom:4px;">
                            MesajÄ±nÄ±z
                        </label>
                        <textarea id="support-message"
                                  rows="4"
                                  placeholder="Sorununuzu veya geri bildiriminizi ayrÄ±ntÄ±lÄ± ÅŸekilde yazÄ±n..."
                                  style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;
                                         font-size:0.95rem;resize:vertical;min-height:120px;box-sizing:border-box;
                                         font-family:inherit;"></textarea>
                    </div>

                    <button id="create-thread" class="cta-button" style="width:100%;margin-top:4px;">
                        GÃ¶nder
                    </button>
                </div>
            </div>

            <!-- KENDÄ° TALEPLERÄ° -->
            <div class="card" style="padding:20px;">
                <h3 style="margin-top:0; margin-bottom:12px;">GeÃ§miÅŸ Destek Taleplerim</h3>

                <div id="my-threads"
                     style="border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;background:#f9fafb;
                            font-size:0.9rem;">
                    HenÃ¼z destek talebiniz yok.
                </div>
            </div>
        </main>
    </div>
</div>

<!-- ============ JS ============ -->
<script type="module">
import { _supabase } from "../../assets/js/supabaseClient.js";

const subjectInput = document.getElementById("support-subject");
const messageInput = document.getElementById("support-message");
const createBtn    = document.getElementById("create-thread");
const threadsBox   = document.getElementById("my-threads");

const getUser = () => JSON.parse(localStorage.getItem("user") || "null");

// --- KULLANICI BÄ°LGÄ°LERÄ°NÄ° GÃœNCELLE (Avatar ve Ä°sim) ---
const initUser = () => {
    const user = getUser();
    if (!user) {
        window.location.href = "../../index.html";
        return;
    }

    // HoÅŸgeldin mesajÄ±
    const welcomeEl = document.getElementById('welcome-message');
    if(welcomeEl) welcomeEl.textContent = "HoÅŸ geldin, " + user.full_name;

    // Profil resmi (Header)
    if (user.avatar_url) {
        const imgEl = document.getElementById('header-avatar');
        if(imgEl) imgEl.src = user.avatar_url;
    }
};

// Kendi taleplerini yÃ¼kle
const loadMyThreads = async () => {
    const user = getUser();
    if (!user) return;

    const { data, error } = await _supabase
        .from("support_threads")
        .select("*")
        .eq("created_by_user_id", user.id)
        .order("created_at", { ascending: false });

    if (error || !data) {
        threadsBox.innerHTML = "YÃ¼klenirken hata oluÅŸtu.";
        return;
    }

    if (data.length === 0) {
        threadsBox.innerHTML = "<p style='color:#6b7280;margin:0;'>HenÃ¼z destek talebiniz yok.</p>";
        return;
    }

    threadsBox.innerHTML = data.map(t => `
        <div style="
            border:1px solid #e5e7eb;
            border-radius:10px;
            padding:10px 12px;
            margin-bottom:8px;
            background:#ffffff;">
            <div style="font-weight:600;font-size:0.95rem;">${t.subject}</div>
            <div style="font-size:0.8rem;color:#6b7280;margin-top:2px;">
                Durum: ${t.status === "open" ? "AÃ§Ä±k" : "KapalÄ±"}
                â€¢ ${new Date(t.created_at).toLocaleString("tr-TR")}
            </div>
        </div>
    `).join("");
};

// Yeni talep oluÅŸtur
createBtn.onclick = async () => {
    const user = getUser();
    if (!user) return;

    const subject = subjectInput.value.trim();
    const message = messageInput.value.trim();

    if (!subject || !message) {
        alert("BaÅŸlÄ±k ve mesaj boÅŸ olamaz!");
        return;
    }

    // 1) thread oluÅŸtur
    const { data: thread, error } = await _supabase
        .from("support_threads")
        .insert({
            created_by_user_id: user.id,
            created_by_role: user.role || "student",
            subject,
            status: "open"
        })
        .select()
        .single();

    if (error) {
        console.error(error);
        alert("Talep oluÅŸturulurken bir hata oluÅŸtu.");
        return;
    }

    // 2) ilk mesajÄ± ekle
    await _supabase
        .from("support_messages")
        .insert({
            thread_id: thread.id,
            sender_user_id: user.id,
            sender_role: user.role || "student",
            message
        });

    subjectInput.value = "";
    messageInput.value = "";

    loadMyThreads();
};

// Ã‡Ä±kÄ±ÅŸ Yap Butonu
document.getElementById('logout-button').onclick = () => {
    localStorage.removeItem('user');
    window.location.href = "../../index.html";
};

// BaÅŸlatÄ±cÄ±lar
initUser();
loadMyThreads();
</script>

</body>
</html>